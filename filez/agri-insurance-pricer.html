<!--
================================================================================
sfHTML INSTRUMENT: PARAMETRIC RISK PRICER (CODEX EDITION v10.2) - BOOTSTRAP BUILD
================================================================================
POR QUE v10.2?
- A v10.1 resolveu scroll + responsividade, mas ainda tinha um risco t√©cnico: IDs duplicados
  (mesmos id="inp-..." no sidebar desktop e no drawer). Em alguns browsers isso pode quebrar
  getElementById e eventos. A v10.2 remove esse risco usando PREFIXOS √∫nicos.

O QUE ENTREGA (end-to-end):
1) N√∫cleo determin√≠stico (observado + previs√£o) -> AccAnom determin√≠stico, gr√°fico, KPIs
2) Hist√≥rico sazonal (ERA5/reanalysis via Open-Meteo Archive) -> janela equivalente em N anos
3) Bootstrap:
   - Bootstrap de anos (resample years)
   - Moving block bootstrap nos res√≠duos di√°rios (preserva depend√™ncia temporal)
4) Outputs:
   - P(trigger)
   - VaR/CVaR do AccAnom (cauda esquerda)
   - Pr√™mio esperado + IC do pr√™mio (percentis 2.5% e 97.5%)
5) UI:
   - Sidebar scroll√°vel (desktop)
   - Drawer (tablet/celular)
   - Tabela com scroll horizontal seguro

================================================================================
-->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Parametric Pricer | v10.2 (Bootstrap)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@300;400;500;600;700&display=swap');
    :root{
      --bg-root:#0f172a; --bg-panel:#1e293b; --bg-input:#334155; --border:#475569;
      --text-main:#f8fafc; --text-muted:#94a3b8; --col-primary:#3b82f6;
    }
    *{box-sizing:border-box;}
    body{
      background:var(--bg-root); color:var(--text-main); font-family:Inter,sans-serif;
      height:100vh; overflow:hidden; display:flex; flex-direction:column;
    }
    .app-header{
      flex:0 0 56px; background:var(--bg-panel); border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; padding:0 12px; z-index:60; gap:12px;
    }
    .app-body{flex:1; display:flex; overflow:hidden; min-height:0;}
    .sidebar{
      width:380px; min-width:320px; max-width:420px; background:var(--bg-panel); border-right:1px solid var(--border);
      display:flex; flex-direction:column; padding:14px; gap:12px; height:100%;
      overflow-y:auto; overflow-x:hidden; overscroll-behavior:contain;
    }
    .main-content{
      flex:1; background:var(--bg-root); position:relative; overflow:hidden; display:flex; flex-direction:column;
      min-width:0; min-height:0;
    }
    #view-dash{overflow-y:auto;}
    #view-docs{overflow-y:auto; height:100%;}
    .card{background:var(--bg-panel); border:1px solid var(--border); border-radius:10px; padding:12px; flex-shrink:0;}
    .card-grow{flex:1; display:flex; flex-direction:column; min-height:180px; overflow:hidden;}
    .list-scroll-area{flex:1; overflow-y:auto; background:var(--bg-input); border-radius:8px; padding:4px;}
    .chk-item{display:flex; align-items:center; gap:10px; padding:8px; border-bottom:1px solid rgba(255,255,255,0.06); cursor:pointer;}
    .chk-item:hover{background:rgba(255,255,255,0.05);}
    .chk-item input{accent-color:var(--col-primary);}
    .chk-label{font-size:12px; color:#cbd5e1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:100%;}
    .lbl{font-size:10px; font-weight:900; color:var(--text-muted); text-transform:uppercase; margin-bottom:4px; display:block; letter-spacing:.08em;}
    .helptext{font-size:12px; line-height:1.4; color:#94a3b8;}
    .input-box{background:var(--bg-root); border:1px solid var(--border); border-radius:8px; padding:8px; display:flex; align-items:center; width:100%;}
    .input-real{background:transparent; border:none; color:white; width:100%; outline:none; font-size:12px; font-family:'JetBrains Mono',monospace;}
    .btn{width:100%; padding:12px; border-radius:10px; border:none; font-weight:900; font-size:11px; text-transform:uppercase; cursor:pointer;
      background:var(--col-primary); color:white; letter-spacing:.06em;}
    .btn:hover{background:#2563eb;}
    .btn-ghost{padding:10px 12px; border-radius:10px; border:1px solid var(--border); color:#cbd5e1; background:rgba(255,255,255,0.02);
      font-weight:800; font-size:11px; text-transform:uppercase; letter-spacing:.06em; cursor:pointer;}
    .btn-ghost:hover{background:rgba(255,255,255,0.05);}
    .nav-btn{background:transparent; border:none; color:var(--text-muted); font-weight:800; padding:0 12px; height:100%;
      cursor:pointer; border-bottom:2px solid transparent; font-size:12px; letter-spacing:.06em; text-transform:uppercase;}
    .nav-btn.active{color:var(--col-primary); border-bottom-color:var(--col-primary);}
    .pill{display:inline-flex; align-items:center; gap:8px; font-family:'JetBrains Mono',monospace; font-size:11px; padding:6px 10px;
      border-radius:999px; background:rgba(59,130,246,0.12); border:1px solid rgba(59,130,246,0.35); color:#bfdbfe; white-space:nowrap;}
    .kpi-inline{font-family:'JetBrains Mono',monospace; font-size:11px; color:#cbd5e1;}
    .kpi-small{font-family:'JetBrains Mono',monospace; font-size:10px; color:#94a3b8;}
    .table-wrap{width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch; background:#0b1223;}
    .data-table{width:100%; border-collapse:collapse; font-size:11px; font-family:'JetBrains Mono',monospace; min-width:980px;}
    .data-table th{background:var(--bg-panel); color:var(--text-muted); padding:10px; position:sticky; top:0; border-bottom:1px solid var(--border); white-space:nowrap; z-index:2;}
    .data-table td{padding:8px 10px; border-bottom:1px solid #13213f; color:var(--text-main); white-space:nowrap;}
    .data-table tr:hover td{background:rgba(51,65,85,0.55); cursor:pointer;}
    .data-table tr.selected td{background:rgba(59,130,246,0.22);}
    .overlay{position:absolute; inset:0; background:rgba(2,6,23,0.90); z-index:55; display:none; align-items:center; justify-content:center; flex-direction:column; padding:18px; gap:10px;}
    .overlay.show{display:flex;}
    .progress{width:min(340px,84vw); height:8px; background:#334155; border-radius:999px; overflow:hidden;}
    .progress>div{height:100%; width:0%; background:var(--col-primary); transition:width .25s;}
    .hidden{display:none !important;}
    .drawer-backdrop{position:fixed; inset:0; background:rgba(2,6,23,0.65); z-index:70; display:none;}
    .drawer-backdrop.show{display:block;}
    .sidebar.drawer{
      position:fixed; top:56px; bottom:0; left:0; z-index:80; transform:translateX(-110%);
      transition:transform .22s ease; width:min(420px,92vw); min-width:unset; max-width:unset;
      box-shadow:18px 0 40px rgba(0,0,0,0.35);
    }
    .sidebar.drawer.open{transform:translateX(0);}
    @media (max-width:1024px){
      .sidebar{display:none;}
      .sidebar.drawer{display:flex;}
    }
    @media (max-width:900px){
      .details-row{flex-direction:column;}
      .kpi-col{width:100% !important;}
      .pill{font-size:10px;}
    }
    ::-webkit-scrollbar{width:8px; height:8px;}
    ::-webkit-scrollbar-thumb{background:#475569; border-radius:6px;}
    ::-webkit-scrollbar-track{background:rgba(15,23,42,0.35);}
  </style>
</head>

<body>
  <header class="app-header">
    <div class="flex items-center gap-3 min-w-0">
      <button id="btn-menu" class="btn-ghost" style="display:none;" onclick="UI.toggleDrawer(true)">Menu</button>
      <div class="min-w-0">
        <div class="text-sm font-extrabold tracking-widest text-white truncate">
          PARAMETRIC<span class="text-blue-500">PRICER</span>
        </div>
        <div class="text-[10px] font-mono text-slate-500">v10.2 ‚Ä¢ H√≠brido + Bootstrap</div>
      </div>
      <div class="hidden sm:block h-6 w-px bg-slate-700 mx-2"></div>
      <div class="flex items-center">
        <button id="tab-dash" class="nav-btn active" onclick="UI.switchTab('dash')">Dashboard</button>
        <button id="tab-docs" class="nav-btn" onclick="UI.switchTab('docs')">Metodologia</button>
      </div>
    </div>

    <div class="text-[10px] font-mono text-slate-500 text-right" id="sys-status">SISTEMA: INATIVO</div>
  </header>

  <div id="drawer-backdrop" class="drawer-backdrop" onclick="UI.toggleDrawer(false)"></div>

  <div class="app-body">
    <aside class="sidebar" aria-label="Painel de controles">
      <div id="sidebar-desk"></div>
    </aside>

    <aside id="sidebar-drawer" class="sidebar drawer" aria-label="Painel de controles (menu)">
      <div id="sidebar-mob"></div>
    </aside>

    <main class="main-content">
      <div id="view-dash" class="flex flex-col h-full p-3 sm:p-4 gap-3" style="overflow-y:auto;">
        <div id="state-empty" class="absolute inset-0 flex flex-col items-center justify-center z-0 pointer-events-none p-6 text-center">
          <div class="text-slate-600 text-6xl mb-4">üìä</div>
          <h2 class="text-slate-200 font-extrabold text-lg">An√°lise do Portf√≥lio</h2>
          <p class="text-slate-400 text-sm mt-2 max-w-xl">
            Em celular/tablet use <strong>Menu</strong>. Selecione regi√µes e clique em <strong>Calcular</strong>.
          </p>
        </div>

        <div id="state-load" class="overlay">
          <div class="text-blue-300 font-mono font-bold animate-pulse">PROCESSANDO‚Ä¶</div>
          <div class="progress"><div id="load-bar"></div></div>
          <div class="text-[11px] font-mono text-slate-300" id="load-hint">Iniciando‚Ä¶</div>
          <div class="text-[10px] font-mono text-slate-500" id="load-subhint"></div>
        </div>

        <div id="state-results" class="hidden flex-col h-full gap-3 relative z-10">
          <div class="card p-0 flex flex-col min-h-[220px] overflow-hidden">
            <div class="p-3 border-b border-slate-700 bg-slate-800 flex justify-between items-center gap-3 flex-wrap">
              <div>
                <div class="lbl text-white">Ranking de risco (determin√≠stico + bootstrap)</div>
                <div class="helptext">Ordena√ß√£o por <strong>P(trigger)</strong> (maior primeiro).</div>
              </div>
              <div class="flex gap-2">
                <button onclick="UI.exportCSV()" class="btn-ghost">Exportar CSV</button>
                <button id="btn-open-menu-2" onclick="UI.toggleDrawer(true)" class="btn-ghost" style="display:none;">Menu</button>
              </div>
            </div>
            <div class="table-wrap">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Regi√£o</th>
                    <th class="text-right">AccAnom (det)</th>
                    <th class="text-right">Gap</th>
                    <th class="text-right">P(trigger)</th>
                    <th class="text-right">VaR</th>
                    <th class="text-right">CVaR</th>
                    <th class="text-right">Pr√™mio (E)</th>
                    <th class="text-right">IC Pr√™mio</th>
                    <th class="text-right">Decis√£o</th>
                  </tr>
                </thead>
                <tbody id="table-ranking"></tbody>
              </table>
            </div>
          </div>

          <div class="details-row flex gap-3 min-h-0">
            <div class="flex-1 card flex flex-col min-h-[320px]">
              <div class="flex justify-between items-start gap-3 flex-wrap">
                <div class="flex flex-col gap-2">
                  <div id="det-title" class="text-lg font-extrabold text-white">--</div>
                  <div class="flex flex-wrap gap-2">
                    <span class="pill">P(trigger): <span id="det-ptrig">--</span></span>
                    <span class="pill">VaR/CVaR: <span id="det-varcvar">--</span></span>
                    <span class="pill">Pr√™mio (E): <span id="det-prem-exp">--</span></span>
                    <span class="pill">IC Pr√™mio: <span id="det-prem-ci">--</span></span>
                  </div>
                </div>
                <span id="det-badge" class="px-3 py-2 rounded-lg text-[11px] font-extrabold bg-slate-700 text-gray-200">--</span>
              </div>

              <div class="mt-3 text-[12px] text-slate-400">
                Linha azul: AccAnom acumulado. Linha vermelha: Trigger. Se azul ficar abaixo da vermelha, bateu o gatilho.
              </div>

              <div class="relative flex-1 min-h-0 mt-2">
                <canvas id="chart-main"></canvas>
              </div>
            </div>

            <div class="kpi-col w-[360px] flex flex-col gap-3">
              <div class="card border-l-4" style="border-left-color:#3b82f6;">
                <span class="lbl" style="color:#93c5fd;">Chuva (det) ‚Ä¢ soma</span>
                <div id="kpi-rain" class="text-2xl font-extrabold font-mono">--</div>
                <div class="kpi-small">Observado + previs√£o (at√© ~16 dias).</div>
              </div>
              <div class="card border-l-4" style="border-left-color:#f59e0b;">
                <span class="lbl" style="color:#fde68a;">AccAnom (det)</span>
                <div id="kpi-anom" class="text-2xl font-extrabold font-mono">--</div>
                <div class="kpi-small">Acumulado (chuva ‚àí baseline).</div>
              </div>
              <div class="card border-l-4" style="border-left-color:#ef4444;">
                <span class="lbl" style="color:#fecaca;">Gap para Trigger</span>
                <div id="kpi-gap" class="text-2xl font-extrabold font-mono">--</div>
                <div class="kpi-small">AccAnom ‚àí Trigger.</div>
              </div>

              <div class="card border-l-4" style="border-left-color:#64748b;">
                <span class="lbl" style="color:#e2e8f0;">Resumo Bootstrap (hist√≥rico)</span>
                <div class="flex justify-between"><div class="kpi-inline">P(trigger)</div><div id="kpi-ptrig" class="font-mono text-sm text-blue-200">--</div></div>
                <div class="flex justify-between"><div class="kpi-inline">VaR (cauda)</div><div id="kpi-var" class="font-mono text-sm text-blue-200">--</div></div>
                <div class="flex justify-between"><div class="kpi-inline">CVaR (cauda)</div><div id="kpi-cvar" class="font-mono text-sm text-blue-200">--</div></div>
                <div class="flex justify-between"><div class="kpi-inline">IC Pr√™mio</div><div id="kpi-premci" class="font-mono text-sm text-blue-200">--</div></div>
                <div class="kpi-small mt-2">VaR/CVaR na cauda esquerda do AccAnom simulado.</div>
              </div>

              <div class="card flex-1 flex flex-col min-h-0 p-0 overflow-hidden">
                <div class="p-3 border-b border-slate-700 bg-slate-800"><span class="lbl mb-0">Log operacional</span></div>
                <div class="flex-1 overflow-auto p-0">
                  <table class="data-table" style="min-width:unset;"><tbody id="table-log"></tbody></table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div><!-- dash -->

      <div id="view-docs" class="hidden">
        <div class="max-w-[980px] mx-auto px-4 py-10 text-slate-300">
          <div class="border-b border-slate-600 pb-6 mb-6">
            <div class="text-blue-300 text-xs font-extrabold tracking-widest mb-2">METODOLOGIA ‚Ä¢ v10.2</div>
            <h1 class="text-2xl md:text-3xl font-extrabold text-white">Como interpretar e operar</h1>
            <p class="mt-2 text-slate-400">
              O painel usa chuva di√°ria e baseline para calcular AccAnom; o bootstrap usa hist√≥rico sazonal para estimar P(trigger),
              VaR/CVaR e intervalo de confian√ßa do pr√™mio.
            </p>
          </div>

          <h2 class="text-xl font-extrabold text-white mt-6 mb-3">1) Defini√ß√µes</h2>
          <pre class="bg-slate-950 border border-slate-700 rounded-xl p-4 text-slate-200 overflow-x-auto text-xs font-mono">
Anomalia(t) = Chuva(t) ‚àí Baseline
AccAnom(T) = Œ£ Anomalia(t)

Trigger √© atingido se: AccAnom ‚â§ Trigger   (Trigger normalmente negativo)
          </pre>

          <h2 class="text-xl font-extrabold text-white mt-6 mb-3">2) Hist√≥rico sazonal (ERA5)</h2>
          <p class="text-slate-400">
            Para a janela [start, end], buscamos a mesma janela (mesmo m√™s/dia e mesmo tamanho) em N anos anteriores.
            Isso d√° uma matriz de trajet√≥rias hist√≥ricas di√°rias.
          </p>

          <h2 class="text-xl font-extrabold text-white mt-6 mb-3">3) Bootstrap (anos + blocos m√≥veis)</h2>
          <pre class="bg-slate-950 border border-slate-700 rounded-xl p-4 text-slate-200 overflow-x-auto text-xs font-mono">
mean(i) = m√©dia entre anos do dia-index i
resid_y(i) = rain_y(i) ‚àí mean(i)

Simula√ß√£o:
- sorteia um ano y* (com reposi√ß√£o)
- sorteia res√≠duos em blocos cont√≠guos (blockLen dias) => preserva depend√™ncia temporal
- rain_sint(i) = mean(i) + resid_sint(i)

Outputs:
P(trigger) = m√©dia( I(AccAnom_sint ‚â§ Trigger) )
VaR/CVaR (cauda esquerda) em AccAnom_sint
Pr√™mio (E) e IC (2.5%, 97.5%) em pr√™mios simulados (apenas cen√°rios n√£o-DECLINE)
          </pre>

          <div class="mt-6 p-4 rounded-xl border border-amber-600/40 bg-amber-500/10">
            <div class="font-extrabold text-amber-200">Observa√ß√£o</div>
            <div class="text-slate-200 mt-1">
              ERA5 √© grade; pode divergir do pluvi√¥metro. Use valida√ß√£o local para underwriting final.
            </div>
          </div>
        </div>
      </div><!-- docs -->
    </main>
  </div>

  <script>
    /* ------------------ REGI√ïES (fallback) ------------------ */
    const FALLBACK_REGIONS = [
      { id: 'mt-sorriso', name: 'Sorriso - MT', lat: -12.54, lon: -55.72 },
      { id: 'go-rioverde', name: 'Rio Verde - GO', lat: -17.79, lon: -50.92 },
      { id: 'pr-cascavel', name: 'Cascavel - PR', lat: -24.95, lon: -53.46 },
      { id: 'ba-lem', name: 'Luis Eduardo Magalh√£es - BA', lat: -12.09, lon: -45.79 },
      { id: 'ma-balsas', name: 'Balsas - MA', lat: -7.53, lon: -46.03 },
      { id: 'mt-sapezal', name: 'Sapezal - MT', lat: -13.55, lon: -58.81 },
      { id: 'go-cristalina', name: 'Cristalina - GO', lat: -16.76, lon: -47.61 },
      { id: 'mt-sinop', name: 'Sinop - MT', lat: -11.86, lon: -55.50 },
      { id: 'pr-londrina', name: 'Londrina - PR', lat: -23.30, lon: -51.16 },
      { id: 'ms-dourados', name: 'Dourados - MS', lat: -22.22, lon: -54.80 },
      { id: 'rs-passofundo', name: 'Passo Fundo - RS', lat: -28.26, lon: -52.40 },
      { id: 'sp-assis', name: 'Assis - SP', lat: -22.66, lon: -50.41 },
      { id: 'mg-uberaba', name: 'Uberaba - MG', lat: -19.74, lon: -47.93 },
      { id: 'to-portonacional', name: 'Porto Nacional - TO', lat: -10.70, lon: -48.41 },
      { id: 'pi-urucui', name: 'Uru√ßu√≠ - PI', lat: -7.22, lon: -44.55 }
    ];

    /* ------------------ UI ------------------ */
    const UI = {
      els: {},
      isDrawerOpen: false,

      init(){
        [
          'tab-dash','tab-docs','view-dash','view-docs','sys-status',
          'state-empty','state-load','state-results','load-bar','load-hint','load-subhint',
          'table-ranking','det-title','det-badge','det-ptrig','det-varcvar','det-prem-exp','det-prem-ci',
          'kpi-rain','kpi-anom','kpi-gap','kpi-ptrig','kpi-var','kpi-cvar','kpi-premci','table-log',
          'drawer-backdrop','btn-menu','btn-open-menu-2'
        ].forEach(id => this.els[id] = document.getElementById(id));

        this.syncResponsiveControls();
        window.addEventListener('resize', () => this.syncResponsiveControls());

        // Render sidebars with unique prefixes to avoid duplicate IDs
        this.renderSidebar('desk', 'sidebar-desk');
        this.renderSidebar('mob',  'sidebar-mob');

        // Default dates
        const t = new Date();
        const past = new Date(); past.setDate(t.getDate() - 60);
        const fut  = new Date(); fut.setDate(t.getDate() + 15);
        this.setVal('desk-inp-start', past.toISOString().split('T')[0]);
        this.setVal('desk-inp-end',   fut.toISOString().split('T')[0]);
        this.setVal('mob-inp-start',  past.toISOString().split('T')[0]);
        this.setVal('mob-inp-end',    fut.toISOString().split('T')[0]);
      },

      syncResponsiveControls(){
        const isSmall = window.matchMedia('(max-width: 1024px)').matches;
        this.els['btn-menu'].style.display = isSmall ? 'inline-flex' : 'none';
        this.els['btn-open-menu-2'].style.display = isSmall ? 'inline-flex' : 'none';
        if (!isSmall) this.toggleDrawer(false);
      },

      toggleDrawer(open){
        const isSmall = window.matchMedia('(max-width: 1024px)').matches;
        if (!isSmall) return;
        this.isDrawerOpen = !!open;
        document.getElementById('sidebar-drawer')?.classList.toggle('open', this.isDrawerOpen);
        this.els['drawer-backdrop']?.classList.toggle('show', this.isDrawerOpen);
      },

      switchTab(t){
        this.els['view-dash'].classList.toggle('hidden', t!=='dash');
        this.els['view-docs'].classList.toggle('hidden', t!=='docs');
        this.els['tab-dash'].classList.toggle('active', t==='dash');
        this.els['tab-docs'].classList.toggle('active', t==='docs');
      },

      updateStatus(msg){ this.els['sys-status'].innerText = `SISTEMA: ${msg}`; },

      setLoading(on, hint, subhint){
        if (on){
          this.els['state-empty'].classList.add('hidden');
          this.els['state-load'].classList.add('show');
          this.updateStatus('CALCULANDO‚Ä¶');
          this.els['load-hint'].innerText = hint || 'Processando‚Ä¶';
          this.els['load-subhint'].innerText = subhint || '';
        } else {
          this.els['state-load'].classList.remove('show');
          this.els['load-subhint'].innerText = '';
        }
      },
      setProgress(p){ this.els['load-bar'].style.width = `${Math.max(0,Math.min(100,p))}%`; },

      fmtPct(x,d=1){ if(x==null||!isFinite(x)) return '--'; return (100*x).toFixed(d)+'%'; },
      fmtNum(x,d=0){ if(x==null||!isFinite(x)) return '--'; return Number(x).toFixed(d); },

      setVal(id,v){ const el=document.getElementById(id); if(el) el.value=v; },

      renderSidebar(prefix, mountId){
        const root = document.getElementById(mountId);
        if(!root) return;

        const P = (id) => `${prefix}-${id}`;

        root.innerHTML = `
          <div class="card">
            <span class="lbl text-blue-300">Como usar (r√°pido)</span>
            <div class="helptext">
              1) Selecione regi√µes<br/>2) Ajuste datas e Trigger<br/>3) Clique <strong>Calcular</strong>
            </div>
          </div>

          <div class="card">
            <span class="lbl text-violet-300">Regras de Underwriting</span>
            <div class="grid grid-cols-2 gap-2 mt-2">
              <div>
                <span class="lbl">Trigger (mm)</span>
                <div class="input-box"><input id="${P('inp-trigger')}" type="number" class="input-real text-red-300 font-bold" value="-150"></div>
              </div>
              <div>
                <span class="lbl">Base Rate (%)</span>
                <div class="input-box"><input id="${P('inp-base')}" type="number" class="input-real" value="3.5" step="0.1" min="0"></div>
              </div>
              <div>
                <span class="lbl">Max Rate (%)</span>
                <div class="input-box"><input id="${P('inp-max')}" type="number" class="input-real" value="12" step="0.1" min="0"></div>
              </div>
              <div>
                <span class="lbl">Modo</span>
                <div class="input-box"><input type="text" class="input-real text-slate-400" value="H√çBRIDO + BOOTSTRAP" readonly></div>
              </div>
            </div>
          </div>

          <div class="card card-grow">
            <div class="flex justify-between items-center mb-2">
              <span class="lbl text-white">Regi√µes</span>
              <span id="${P('lbl-count')}" class="text-[10px] text-blue-300 font-extrabold">0 selecionadas</span>
            </div>

            <div class="input-box mb-2" style="padding:6px 8px;">
              <input id="${P('inp-search')}" type="text" class="input-real" placeholder="Filtrar lista..." />
            </div>

            <div id="${P('list-container')}" class="list-scroll-area">
              <div class="p-4 text-center text-xs text-gray-500">Carregando‚Ä¶</div>
            </div>

            <div class="flex gap-2 mt-2 pt-2 border-t border-slate-700">
              <button id="${P('btn-all')}" class="bg-slate-700 text-white text-[10px] py-2 px-2 rounded-lg hover:bg-slate-600 flex-1 font-bold">TODAS</button>
              <button id="${P('btn-none')}" class="bg-slate-700 text-white text-[10px] py-2 px-2 rounded-lg hover:bg-slate-600 flex-1 font-bold">NENHUMA</button>
            </div>
          </div>

          <div class="card">
            <span class="lbl text-blue-300">Controles do Bootstrap</span>
            <div class="grid grid-cols-2 gap-2 mt-2">
              <div>
                <span class="lbl">Anos hist√≥ricos</span>
                <div class="input-box"><input id="${P('inp-hist-years')}" type="number" class="input-real" value="20" step="1" min="5" max="60"></div>
              </div>
              <div>
                <span class="lbl">Simula√ß√µes</span>
                <div class="input-box"><input id="${P('inp-sims')}" type="number" class="input-real" value="1000" step="100" min="200" max="20000"></div>
              </div>
              <div>
                <span class="lbl">Bloco (dias)</span>
                <div class="input-box"><input id="${P('inp-block')}" type="number" class="input-real" value="7" step="1" min="2" max="30"></div>
              </div>
              <div>
                <span class="lbl">N√≠vel VaR</span>
                <div class="input-box"><input id="${P('inp-var')}" type="number" class="input-real" value="0.95" step="0.01" min="0.80" max="0.99"></div>
              </div>
            </div>
            <div class="helptext mt-2">Hist√≥rico via ERA5 (reanalysis) ‚Ä¢ janelas sazonais equivalentes.</div>
          </div>

          <div class="card">
            <span class="lbl">Janela de an√°lise</span>
            <div class="grid grid-cols-2 gap-2 mb-2">
              <input id="${P('inp-start')}" type="date" class="input-box text-[11px]">
              <input id="${P('inp-end')}" type="date" class="input-box text-[11px]">
            </div>
            <button id="${P('btn-run')}" class="btn">Calcular</button>
            <div class="helptext mt-2">Previs√£o limitada a ~16 dias; risco probabil√≠stico vem do hist√≥rico.</div>
          </div>
        `;

        // wire events
        root._refs = {
          prefix,
          list: document.getElementById(P('list-container')),
          search: document.getElementById(P('inp-search')),
          lblCount: document.getElementById(P('lbl-count'))
        };

        root._refs.search?.addEventListener('keyup', (e)=>UI.filterRegions(prefix, e.target.value));
        document.getElementById(P('btn-all'))?.addEventListener('click', ()=>UI.toggleAll(prefix, true));
        document.getElementById(P('btn-none'))?.addEventListener('click', ()=>UI.toggleAll(prefix, false));
        document.getElementById(P('btn-run'))?.addEventListener('click', ()=>App.run());

        root._refs.list?.addEventListener('change', ()=>UI.updateCount(prefix));
      },

      // render list into both sidebars (desk + mob)
      renderRegionList(list){
        list.sort((a,b)=>a.name.localeCompare(b.name));
        const html = list.map(r=>`
          <label class="chk-item" data-search="${(r.name||'').toLowerCase()}">
            <input type="checkbox" value="${r.id}">
            <span class="chk-label" title="${r.name}">${r.name}</span>
          </label>
        `).join('');

        ['desk','mob'].forEach(prefix=>{
          const c = document.getElementById(`${prefix}-list-container`);
          if (c) c.innerHTML = html;
          this.updateCount(prefix);
        });
      },

      filterRegions(prefix, val){
        const c = document.getElementById(`${prefix}-list-container`);
        if(!c) return;
        const q=(val||'').toLowerCase();
        for (let item of c.children){
          const name=item.getAttribute('data-search')||'';
          item.style.display = name.includes(q) ? 'flex' : 'none';
        }
      },

      toggleAll(prefix, on){
        const c = document.getElementById(`${prefix}-list-container`);
        if(!c) return;
        c.querySelectorAll('input[type="checkbox"]').forEach(i=>{
          if (i.parentElement.style.display !== 'none') i.checked = on;
        });
        this.syncSelections(prefix);
      },

      updateCount(prefix){
        const c = document.getElementById(`${prefix}-list-container`);
        const lbl = document.getElementById(`${prefix}-lbl-count`);
        if(!c || !lbl) return;
        const n = c.querySelectorAll('input:checked').length;
        lbl.innerText = `${n} selecionadas`;
      },

      syncSelections(sourcePrefix){
        const src = document.getElementById(`${sourcePrefix}-list-container`);
        const dstPrefix = (sourcePrefix === 'desk') ? 'mob' : 'desk';
        const dst = document.getElementById(`${dstPrefix}-list-container`);
        if(!src || !dst) return;

        const selected = new Set(Array.from(src.querySelectorAll('input:checked')).map(x=>x.value));
        dst.querySelectorAll('input[type="checkbox"]').forEach(x=>{ x.checked = selected.has(x.value); });

        this.updateCount('desk');
        this.updateCount('mob');
      },

      getSelectedRegionIds(){
        const c = document.getElementById('desk-list-container') || document.getElementById('mob-list-container');
        if(!c) return [];
        return Array.from(c.querySelectorAll('input:checked')).map(x=>x.value);
      },

      // get inputs with fallback: desk first, then mob
      getNum(id){
        const a = document.getElementById(`desk-${id}`) || document.getElementById(`mob-${id}`);
        const x = a ? parseFloat(a.value) : NaN;
        return isFinite(x) ? x : null;
      },
      getInt(id){
        const x = this.getNum(id);
        return (x==null) ? null : (x|0);
      },
      getStr(id){
        const a = document.getElementById(`desk-${id}`) || document.getElementById(`mob-${id}`);
        return a ? a.value : null;
      },

      showResults(results, activeId){
        this.els['state-results'].classList.remove('hidden');

        const sorted = Object.values(results).sort((a,b)=>{
          const pa=a.pTrigger ?? -1, pb=b.pTrigger ?? -1;
          if (pb!==pa) return pb-pa;
          return (a.anom ?? 0) - (b.anom ?? 0);
        });

        this.els['table-ranking'].innerHTML = sorted.map(r=>`
          <tr onclick="App.selectRegion('${r.id}')" class="${r.id===activeId?'selected':''}">
            <td class="font-bold text-white">${r.name}</td>
            <td class="text-right ${r.anom<0?'text-red-300':'text-emerald-300'}">${UI.fmtNum(r.anom,0)}</td>
            <td class="text-right text-slate-300">${UI.fmtNum(r.gap,0)}</td>
            <td class="text-right text-blue-200">${UI.fmtPct(r.pTrigger,1)}</td>
            <td class="text-right text-blue-200">${UI.fmtNum(r.varAccAnom,0)}</td>
            <td class="text-right text-blue-200">${UI.fmtNum(r.cvarAccAnom,0)}</td>
            <td class="text-right text-white">${r.premiumExp!=null?UI.fmtNum(r.premiumExp,2)+'%':'--'}</td>
            <td class="text-right text-slate-300">${(r.premiumCI?.lo!=null)?(UI.fmtNum(r.premiumCI.lo,2)+'‚Äì'+UI.fmtNum(r.premiumCI.hi,2)+'%'):'--'}</td>
            <td class="text-right font-extrabold ${r.decision==='DECLINE'?'text-red-400':(r.decision==='HIGH RISK'?'text-amber-300':'text-emerald-300')}">${r.decision}</td>
          </tr>
        `).join('');

        if(activeId && results[activeId]){
          const r = results[activeId];
          this.els['det-title'].innerText = r.name;

          this.els['det-badge'].innerText = r.decision;
          this.els['det-badge'].className =
            `px-3 py-2 rounded-lg text-[11px] font-extrabold ${
              r.decision==='DECLINE' ? 'bg-red-900 text-red-100' :
              r.decision==='HIGH RISK' ? 'bg-amber-900 text-amber-100' :
              'bg-emerald-900 text-emerald-100'
            }`;

          this.els['kpi-rain'].innerText = UI.fmtNum(r.rain,0);
          this.els['kpi-anom'].innerText = UI.fmtNum(r.anom,0);
          this.els['kpi-gap'].innerText  = UI.fmtNum(r.gap,0);

          this.els['kpi-ptrig'].innerText = UI.fmtPct(r.pTrigger,1);
          this.els['kpi-var'].innerText   = UI.fmtNum(r.varAccAnom,0);
          this.els['kpi-cvar'].innerText  = UI.fmtNum(r.cvarAccAnom,0);
          this.els['kpi-premci'].innerText = (r.premiumCI?.lo!=null)
            ? `${UI.fmtNum(r.premiumCI.lo,2)}‚Äì${UI.fmtNum(r.premiumCI.hi,2)}%` : '--';

          this.els['det-ptrig'].innerText = UI.fmtPct(r.pTrigger,1);
          this.els['det-varcvar'].innerText = (r.varAccAnom!=null && r.cvarAccAnom!=null)
            ? `${UI.fmtNum(r.varAccAnom,0)} / ${UI.fmtNum(r.cvarAccAnom,0)}` : '--';
          this.els['det-prem-exp'].innerText = (r.premiumExp!=null) ? (UI.fmtNum(r.premiumExp,2)+'%') : '--';
          this.els['det-prem-ci'].innerText = (r.premiumCI?.lo!=null)
            ? `${UI.fmtNum(r.premiumCI.lo,2)}‚Äì${UI.fmtNum(r.premiumCI.hi,2)}%` : '--';

          this.els['table-log'].innerHTML = r.series.slice(-25).reverse().map(s=>`
            <tr>
              <td class="text-slate-500 text-[10px]">${s.date}</td>
              <td class="text-right font-mono text-[11px] ${s.anom<0?'text-red-300':'text-emerald-300'}">${s.anom.toFixed(0)}</td>
            </tr>
          `).join('');

          this.renderChart(r);
        }
      },

      renderChart(r){
        const canvas = document.getElementById('chart-main');
        if(!canvas) return;
        const ctx = canvas.getContext('2d');
        if(window.myChart) window.myChart.destroy();

        const labels = r.series.map(s=>s.date);
        const acc = r.series.map(s=>s.accAnom);
        const trig = Array(labels.length).fill(r.trigger);

        window.myChart = new Chart(ctx, {
          type:'line',
          data:{ labels, datasets:[
            { label:'Trigger', data:trig, borderColor:'#ef4444', borderDash:[6,6], pointRadius:0, borderWidth:1 },
            { label:'AccAnom', data:acc, borderColor:'#3b82f6', backgroundColor:'rgba(59,130,246,0.10)', fill:true, pointRadius:0, borderWidth:2 }
          ]},
          options:{
            responsive:true, maintainAspectRatio:false,
            interaction:{mode:'index', intersect:false},
            scales:{
              x:{ grid:{color:'#334155'}, ticks:{color:'#94a3b8', font:{size:10}} },
              y:{ grid:{color:'#334155'}, ticks:{color:'#94a3b8'} }
            },
            plugins:{ legend:{display:false}, tooltip:{enabled:true} }
          }
        });
      },

      exportCSV(){
        if(!App.results) return;
        let csv = "Region,DetRain,DetAccAnom,Gap,PTrigger,VaR,CVaR,PremExp,PremCI_Lo,PremCI_Hi,Decision,YearsUsed\n";
        Object.values(App.results).forEach(r=>{
          csv += `"${r.name}",${r.rain},${r.anom},${r.gap},${r.pTrigger},${r.varAccAnom},${r.cvarAccAnom},${r.premiumExp},${r.premiumCI?.lo ?? ""},${r.premiumCI?.hi ?? ""},${r.decision},${r.yearsUsed}\n`;
        });
        const blob = new Blob([csv], {type:'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'risk_report_bootstrap_v10_2.csv'; a.click();
      }
    };

    /* ------------------ DATA ------------------ */
    const Data = {
      regions:{},
      cache:new Map(),
      constants:{ FORECAST_MAX_DAYS:16, FETCH_TIMEOUT_MS:14000, MAX_HISTORY_YEARS_HARD:60, CONCURRENCY:4 },

      ymd(d){ return new Date(d).toISOString().slice(0,10); },

      validateInputs(start,end){
        const s=new Date(start), e=new Date(end);
        if(isNaN(s.getTime())||isNaN(e.getTime())) return {ok:false,msg:"Datas inv√°lidas."};
        if(s>e) return {ok:false,msg:"Data inicial deve ser <= data final."};
        return {ok:true};
      },

      daysBetweenInclusive(startYMD,endYMD){
        const s=new Date(startYMD), e=new Date(endYMD);
        return Math.floor((e.getTime()-s.getTime())/(24*3600*1000))+1;
      },

      cappedForecastEnd(end){
        const today=new Date(); const maxF=new Date(today); maxF.setDate(today.getDate()+this.constants.FORECAST_MAX_DAYS);
        const endD=new Date(end);
        return this.ymd(endD>maxF?maxF:endD);
      },

      async fetchWithTimeout(url,ms){
        const controller=new AbortController();
        const t=setTimeout(()=>controller.abort(),ms);
        try{
          const res=await fetch(url,{signal:controller.signal});
          if(!res.ok) throw new Error(`HTTP ${res.status}`);
          return await res.json();
        } finally { clearTimeout(t); }
      },

      mkForecastURL(lat,lon,start,end){
        return `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&start_date=${start}&end_date=${end}&daily=precipitation_sum&timezone=America%2FSao_Paulo`;
      },
      mkArchiveURL(lat,lon,start,end){
        return `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${start}&end_date=${end}&daily=precipitation_sum&timezone=America%2FSao_Paulo`;
      },

      async loadRegions(){
        UI.updateStatus("CARREGANDO BASE‚Ä¶");

        FALLBACK_REGIONS.forEach(r => this.regions[r.id] = {...r, baseline: 6.0});
        UI.renderRegionList(Object.values(this.regions));

        // optional online DB
        try{
          const controller=new AbortController();
          const timeoutId=setTimeout(()=>controller.abort(),2500);
          const res=await fetch('https://raw.githubusercontent.com/FrancyJGLisboa/agri-feeders/main/data/ibge-data.json',{signal:controller.signal});
          clearTimeout(timeoutId);
          if(!res.ok) throw new Error("DB online indispon√≠vel");
          const data=await res.json();
          if(!data?.municipios) throw new Error("DB online sem municipios");

          this.regions = {};
          Object.keys(data.municipios).forEach(k=>{
            const m=data.municipios[k];
            this.regions[k]={id:k, name:k.toUpperCase(), lat:m.lat, lon:m.lon, baseline:6.0};
          });

          UI.renderRegionList(Object.values(this.regions));
          UI.updateStatus("ONLINE (DB)");
        } catch(e){
          console.warn("DB online falhou; usando fallback.", e);
          UI.updateStatus("OFFLINE (FALLBACK)");
        }
      },

      async fetchWeatherHybrid(lat,lon,start,end){
        const key=`HYB|${lat},${lon}|${start}|${end}`;
        if(this.cache.has(key)) return this.cache.get(key);

        const today=new Date();
        const todayYMD=this.ymd(today);
        const startD=new Date(start), endD=new Date(end);
        const cappedEnd=this.cappedForecastEnd(end);

        const stitch=(a,f)=>{
          if(!a?.daily && f?.daily) return f;
          if(a?.daily && !f?.daily) return a;
          if(!a?.daily && !f?.daily) return null;
          return { daily:{
            time:[...a.daily.time,...f.daily.time],
            precipitation_sum:[...a.daily.precipitation_sum,...f.daily.precipitation_sum]
          }};
        };

        try{
          if(endD < new Date(todayYMD)){
            const a=await this.fetchWithTimeout(this.mkArchiveURL(lat,lon,start,end), this.constants.FETCH_TIMEOUT_MS);
            this.cache.set(key,a); return a;
          }
          if(startD >= new Date(todayYMD)){
            const f=await this.fetchWithTimeout(this.mkForecastURL(lat,lon,start,cappedEnd), this.constants.FETCH_TIMEOUT_MS);
            this.cache.set(key,f); return f;
          }
          const y=new Date(today); y.setDate(today.getDate()-1);
          const yYMD=this.ymd(y);
          const [a,f]=await Promise.all([
            this.fetchWithTimeout(this.mkArchiveURL(lat,lon,start,yYMD), this.constants.FETCH_TIMEOUT_MS),
            this.fetchWithTimeout(this.mkForecastURL(lat,lon,todayYMD,cappedEnd), this.constants.FETCH_TIMEOUT_MS)
          ]);
          const out=stitch(a,f);
          this.cache.set(key,out); return out;
        } catch(e){
          console.warn("Falha clima h√≠brido:", e);
          this.cache.set(key,null); return null;
        }
      },

      buildSeasonalWindowForYear(userStartYMD, windowLenDays, year){
        const s = new Date(userStartYMD+"T00:00:00Z");
        const start = new Date(Date.UTC(year, s.getUTCMonth(), s.getUTCDate()));
        const end = new Date(start);
        end.setUTCDate(start.getUTCDate() + (windowLenDays - 1));
        return { startYMD: this.ymd(start), endYMD: this.ymd(end) };
      },

      async fetchHistoryMatrix(lat,lon,userStart,userEnd,histYears){
        const histN=Math.min(Math.max(5, histYears|0), this.constants.MAX_HISTORY_YEARS_HARD);
        const windowLen=this.daysBetweenInclusive(userStart,userEnd);

        const now=new Date();
        const lastFullYear=now.getUTCFullYear()-1;
        const years=[]; for(let k=0;k<histN;k++) years.push(lastFullYear-k);

        const rainByYear=new Map();
        const queue=years.slice();
        const self=this;

        async function worker(){
          while(queue.length){
            const y=queue.shift();
            const w=self.buildSeasonalWindowForYear(userStart, windowLen, y);
            const key=`HIST|${lat},${lon}|${w.startYMD}|${w.endYMD}`;
            if(self.cache.has(key)){ rainByYear.set(y,self.cache.get(key)); continue; }

            try{
              const a=await self.fetchWithTimeout(self.mkArchiveURL(lat,lon,w.startYMD,w.endYMD), self.constants.FETCH_TIMEOUT_MS);
              const ok=a && a.daily && Array.isArray(a.daily.time) && Array.isArray(a.daily.precipitation_sum);
              if(!ok) throw new Error("Payload inv√°lido (archive)");

              const n=Math.min(a.daily.time.length, a.daily.precipitation_sum.length);
              const arr=new Array(windowLen).fill(0);
              for(let i=0;i<Math.min(n,windowLen);i++) arr[i]=(a.daily.precipitation_sum[i] ?? 0) || 0;

              self.cache.set(key,arr);
              rainByYear.set(y,arr);
            } catch(e){
              console.warn("Hist√≥rico falhou ano", y, e);
              self.cache.set(key,null);
              rainByYear.set(y,null);
            }
          }
        }

        const W=Math.max(1, Math.min(this.constants.CONCURRENCY, 6));
        await Promise.all(Array.from({length:W}, ()=>worker()));

        const yearsOk=years.filter(y=>Array.isArray(rainByYear.get(y)));
        const rainOk=new Map(); yearsOk.forEach(y=>rainOk.set(y,rainByYear.get(y)));
        return { years: yearsOk, rainByYear: rainOk, windowLen };
      }
    };

    /* ------------------ RISK / BOOTSTRAP ------------------ */
    const Risk = {
      mean(arr){ if(!arr||!arr.length) return null; let s=0; for(const x of arr) s+=x; return s/arr.length; },
      quantile(sorted,q){
        if(!sorted||!sorted.length) return null;
        const n=sorted.length; const pos=(n-1)*q; const lo=Math.floor(pos), hi=Math.ceil(pos);
        if(lo===hi) return sorted[lo];
        const w=pos-lo; return sorted[lo]*(1-w)+sorted[hi]*w;
      },
      movingBlockBootstrap(residuals, blockLen, outLen){
        const L=residuals.length;
        const B=Math.max(2, Math.min(blockLen|0, L));
        const out=new Array(outLen);
        let i=0;
        while(i<outLen){
          const start=Math.floor(Math.random()*Math.max(1,(L-B+1)));
          for(let k=0;k<B && i<outLen;k++) out[i++]=residuals[start+k];
        }
        return out;
      },
      computePremiumFromAccAnom(accAnom, trigger, baseRate, maxRate){
        const gap=accAnom-trigger;
        if(accAnom <= trigger) return { decision:"DECLINE", premium:0, score:100, gap };
        const ratio=Math.max(0, 1 - (gap/Math.abs(trigger)));
        const score=ratio*90;
        let decision="ACCEPT", premium=baseRate;
        if(ratio>0.5){ decision="HIGH RISK"; premium=baseRate + ((maxRate-baseRate)*ratio); }
        return { decision, premium, score, gap };
      },

      bootstrapMetrics({years, rainByYear, baseline, trigger, sims, blockLen, varLevel, baseRate, maxRate}){
        const L = years.length ? (rainByYear.get(years[0])?.length || 0) : 0;
        if(!years.length || L<3){
          return { pTrigger:null, varAccAnom:null, cvarAccAnom:null, premiumExp:null, premiumCI:{lo:null, hi:null} };
        }

        // mean series per day index
        const meanSeries=new Array(L).fill(0);
        for(let i=0;i<L;i++){
          let s=0,c=0;
          for(const y of years){
            const arr=rainByYear.get(y);
            if(!arr) continue;
            s+=arr[i]; c++;
          }
          meanSeries[i]=c?(s/c):0;
        }

        // residuals
        const residByYear=new Map();
        for(const y of years){
          const arr=rainByYear.get(y);
          if(!arr) continue;
          const res=new Array(L);
          for(let i=0;i<L;i++) res[i]=arr[i]-meanSeries[i];
          residByYear.set(y,res);
        }

        const accAnoms=new Array(sims);
        let breach=0;
        const premIns=[];

        for(let s=0;s<sims;s++){
          const y=years[Math.floor(Math.random()*years.length)];
          const resid=residByYear.get(y) || new Array(L).fill(0);

          const synthResid=this.movingBlockBootstrap(resid, blockLen, L);

          let accAnom=0;
          for(let i=0;i<L;i++){
            const rain=(meanSeries[i]+synthResid[i]);
            accAnom += (rain - baseline);
          }

          accAnoms[s]=accAnom;
          if(accAnom <= trigger) breach++;

          const pr=this.computePremiumFromAccAnom(accAnom, trigger, baseRate, maxRate);
          if(pr.decision!=="DECLINE" && isFinite(pr.premium)) premIns.push(pr.premium);
        }

        const pTrigger=breach/sims;

        // left tail
        const qLeft=Math.max(0.001, Math.min(0.5, 1-varLevel));
        const sortedAcc=accAnoms.slice().sort((a,b)=>a-b);
        const varAccAnom=this.quantile(sortedAcc, qLeft);

        let cvarAccAnom=null;
        if(varAccAnom!=null){
          let s=0,c=0;
          for(const x of accAnoms){ if(x<=varAccAnom){ s+=x; c++; } }
          cvarAccAnom=c?(s/c):null;
        }

        let premiumExp=null, premiumCI={lo:null, hi:null};
        if(premIns.length){
          premiumExp=this.mean(premIns);
          const sp=premIns.slice().sort((a,b)=>a-b);
          premiumCI.lo=this.quantile(sp, 0.025);
          premiumCI.hi=this.quantile(sp, 0.975);
        }

        return { pTrigger, varAccAnom, cvarAccAnom, premiumExp, premiumCI };
      }
    };

    /* ------------------ APP ------------------ */
    const App = {
      results:{},
      activeId:null,

      async init(){
        UI.init();
        await Data.loadRegions();
      },

      async run(){
        UI.toggleDrawer(false);

        const targets = UI.getSelectedRegionIds();
        if(!targets.length) return alert("Selecione pelo menos 1 regi√£o.");

        const start = UI.getStr('inp-start');
        const end   = UI.getStr('inp-end');
        const v = Data.validateInputs(start,end);
        if(!v.ok) return alert(v.msg);

        const trigger  = UI.getNum('inp-trigger');
        const baseRate = UI.getNum('inp-base');
        const maxRate  = UI.getNum('inp-max');
        const histYears= UI.getInt('inp-hist-years') ?? 20;
        const sims     = UI.getInt('inp-sims') ?? 1000;
        const blockLen = UI.getInt('inp-block') ?? 7;
        const varLevel = UI.getNum('inp-var') ?? 0.95;

        if(![trigger,baseRate,maxRate].every(x=>x!=null)) return alert("Inputs de pricing inv√°lidos.");
        if(histYears<5) return alert("Anos hist√≥ricos deve ser ‚â• 5.");
        if(sims<200) return alert("Simula√ß√µes deve ser ‚â• 200.");
        if(blockLen<2) return alert("Bloco (dias) deve ser ‚â• 2.");
        if(!(varLevel>0.5 && varLevel<1.0)) return alert("N√≠vel VaR deve estar entre 0.50 e 0.99.");

        const cappedEnd = Data.cappedForecastEnd(end);
        const isCapped = (new Date(end).getTime() > new Date(cappedEnd).getTime());

        this.results={}; this.activeId=null;

        UI.setLoading(true,
          isCapped ? "Previs√£o limitada (~16 dias). Rodando h√≠brido + bootstrap‚Ä¶" : "Rodando h√≠brido + bootstrap‚Ä¶",
          `Hist√≥rico: ${histYears} anos | Sims: ${sims} | Bloco: ${blockLen} dias | VaR: ${varLevel}`
        );
        UI.setProgress(2);

        try{
          const BATCH=3;
          const total=targets.length;

          for(let i=0;i<targets.length;i+=BATCH){
            const batch=targets.slice(i,i+BATCH);

            await Promise.all(batch.map(async id=>{
              const reg=Data.regions[id];
              if(!reg) return;

              UI.els['load-hint'].innerText = `Regi√£o: ${reg.name}`;

              // 1) deterministic
              const w = await Data.fetchWeatherHybrid(reg.lat, reg.lon, start, end);
              const ok = w && w.daily && Array.isArray(w.daily.time) && Array.isArray(w.daily.precipitation_sum);
              if(!ok){ console.warn("H√≠brido inv√°lido:", reg.name, w); return; }

              const series=[];
              let accAnom=0, accRain=0;
              const n=Math.min(w.daily.time.length, w.daily.precipitation_sum.length);
              for(let idx=0; idx<n; idx++){
                const t=w.daily.time[idx];
                const rain=(w.daily.precipitation_sum[idx] ?? 0) || 0;
                const anom=rain - reg.baseline;
                accRain += rain;
                accAnom += anom;
                series.push({date:t, rain, anom, accAnom});
              }

              const det = Risk.computePremiumFromAccAnom(accAnom, trigger, baseRate, maxRate);

              // 2) history matrix
              UI.els['load-subhint'].innerText = `Hist√≥rico/Bootstrap: ${reg.name}`;
              const hist = await Data.fetchHistoryMatrix(reg.lat, reg.lon, start, end, histYears);

              // 3) bootstrap metrics
              const metrics = Risk.bootstrapMetrics({
                years: hist.years,
                rainByYear: hist.rainByYear,
                baseline: reg.baseline,
                trigger, sims, blockLen, varLevel, baseRate, maxRate
              });

              this.results[id] = {
                id, name: reg.name, series,
                rain: accRain, anom: accAnom, gap: det.gap,
                score: det.score, decision: det.decision,
                trigger, premiumDet: det.premium,

                yearsUsed: hist.years.length,
                pTrigger: metrics.pTrigger,
                varAccAnom: metrics.varAccAnom,
                cvarAccAnom: metrics.cvarAccAnom,
                premiumExp: metrics.premiumExp,
                premiumCI: metrics.premiumCI
              };
            }));

            const pct=((i+BATCH)/total)*100;
            UI.setProgress(Math.min(100,pct));
          }

          UI.setLoading(false);
          UI.updateStatus(isCapped ? "OK (PREVIS√ÉO LIMITADA)" : "OK");

          const worst = Object.values(this.results).sort((a,b)=>{
            const pa=a.pTrigger ?? -1, pb=b.pTrigger ?? -1;
            if(pb!==pa) return pb-pa;
            return (a.anom ?? 0) - (b.anom ?? 0);
          })[0];

          if(worst) this.selectRegion(worst.id);
          else alert("Nenhum resultado. Verifique rede/console.");

        } catch(e){
          console.error("Falha:", e);
          UI.setLoading(false);
          alert("Falha no c√°lculo. Verifique console/rede.");
        }
      },

      selectRegion(id){
        this.activeId=id;
        UI.showResults(this.results, id);
      }
    };

    window.addEventListener('DOMContentLoaded', ()=>App.init());
  </script>
</body>
</html>
